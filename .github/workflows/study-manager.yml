name: ðŸ† Weekly Study Leaderboard

on:
  schedule:
    - cron: '0 0 * * 1' # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST)
  workflow_dispatch: 

jobs:
  leaderboard:
    runs-on: ubuntu-latest
    steps:
      - name: Get Last Week Date
        id: date
        run: echo "since=$(date -d '7 days ago' +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Calculate Ranking
        id: ranking
        run: |
          ORG_NAME="dangerous-office-workers"
          SINCE_DATE="${{ steps.date.outputs.since }}"
          echo "[INFO] $ORG_NAME ì˜ $SINCE_DATE ì´í›„ ê¸°ë¡ì„ ì°¾ìŠµë‹ˆë‹¤..."

          # 1. gh search ëª…ë ¹ì–´ë¡œ ì»¤ë°‹ ìž‘ì„±ìž ì•„ì´ë””ë§Œ ì •í™•ížˆ ì¶”ì¶œ (ì—ëŸ¬ ë°œìƒ ì‹œ ë¹ˆê°’ ì²˜ë¦¬)
          # jq í•„í„°ë¥¼ ê°•í™”í•˜ì—¬ ì˜¤ì§ ì˜ë¬¸/ìˆ«ìž ì•„ì´ë””ë§Œ ë½‘ì•„ì˜¤ë„ë¡ ì„¤ì •
          AUTHORS=$(gh search commits --owner "$ORG_NAME" --author-date ">=$SINCE_DATE" --limit 100 --json author --jq '.[].author.login' 2>/dev/null || echo "")

          # 2. ê²°ê³¼ ë©”ì‹œì§€ ìž‘ì„± ì‹œìž‘
          {
            echo "content<<EOF"
            echo "ðŸ“¢ *[ìœ„í—˜í•œ ì§ìž¥ì¸ë“¤] ì´ë²ˆ ì£¼ ìŠ¤í„°ë”” ëž­í‚¹ ì •ë¦¬*"
            echo ""
            
            # AUTHORSê°€ ë¹„ì–´ìžˆê±°ë‚˜ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ì„žì¸ ê²½ìš° ë°©ì§€
            if [ -z "$AUTHORS" ] || [[ "$AUTHORS" == *"message"* ]]; then
              echo "ì§€ë‚œì£¼ì—ëŠ” í™œë™í•œ ë©¤ë²„ê°€ ì—†ë„¤ìš”. ëª¨ë‘ ë¶„ë°œí•˜ì„¸ìš”! â„ï¸"
            else
              echo "ì§€ë‚œ ì¼ì£¼ì¼ê°„ì˜ ëª…ì˜ˆì˜ ì „ë‹¹ìž…ë‹ˆë‹¤! ðŸ†"
              # ëž­í‚¹ ê³„ì‚° (ì‹¤ì œ ì•„ì´ë””ê°€ ìžˆëŠ” ê²½ìš°ë§Œ ì²˜ë¦¬)
              echo "$AUTHORS" | grep -v "null" | sort | uniq -c | sort -rn | awk '
                BEGIN { rank=1 }
                {
                  emoji = (rank == 1 ? "ðŸ¥‡" : (rank == 2 ? "ðŸ¥ˆ" : (rank == 3 ? "ðŸ¥‰" : "â€¢")))
                  printf "%s %dìœ„: @%s (%d commits)\n", emoji, rank, $2, $1
                  rank++
                }'
            fi
            echo ""
            echo "_ìˆœìœ„ì— ì—†ìœ¼ì‹  ë¶„ë“¤ì€ ë‹¤ìŒ ì£¼ë¥¼ ë…¸ë ¤ë³´ì„¸ìš”! ðŸ”¥_"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send to Slack
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": ${{ toJSON(steps.ranking.outputs.content) }}
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
