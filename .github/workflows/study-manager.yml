name: ğŸ† Weekly Study Leaderboard

on:
  schedule:
    - cron: '0 0 * * 1' # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST)
  workflow_dispatch:

jobs:
  leaderboard:
    runs-on: ubuntu-latest
    steps:
      - name: Get Last Week Date
        id: date
        run: echo "since=$(date -d '7 days ago' +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Calculate Ranking
        id: ranking
        run: |
          # 1. ì¡°ì§ ID ì„¤ì •
          ORG_NAME="dangerous-office-workers"
          SINCE_DATE="${{ steps.date.outputs.since }}"
          echo "[INFO] Searching records for $ORG_NAME since $SINCE_DATE..."

          # 2. ì»¤ë°‹ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê³µë°±/íŠ¹ìˆ˜ë¬¸ì ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ -f ì‚¬ìš©)
          QUERY="org:$ORG_NAME author-date:>=$SINCE_DATE merge:false"
          AUTHORS=$(gh api "search/commits" -f q="$QUERY" --jq '.items[].author.login' || echo "")

          # 3. ìŠ¬ë™ì— ë³´ë‚¼ ë©”ì‹œì§€ êµ¬ì„± (Heredoc ì˜¤íƒ€ ìˆ˜ì •)
          {
            echo "content<<EOF"
            echo "ğŸ“¢ *[ìœ„í—˜í•œ ì§ì¥ì¸ë“¤] ì´ë²ˆ ì£¼ ìŠ¤í„°ë”” ë­í‚¹ ì •ë¦¬*"
            echo ""
            if [ -z "$AUTHORS" ]; then
              echo "ì§€ë‚œì£¼ì—ëŠ” í™œë™í•œ ë©¤ë²„ê°€ ì—†ë„¤ìš”. ëª¨ë‘ ë¶„ë°œí•˜ì„¸ìš”! â„ï¸"
            else
              echo "ì§€ë‚œ ì¼ì£¼ì¼ê°„ì˜ ëª…ì˜ˆì˜ ì „ë‹¹ì…ë‹ˆë‹¤! ğŸ†"
              # ë­í‚¹ ê³„ì‚°
              echo "$AUTHORS" | sort | uniq -c | sort -rn | awk '
                BEGIN { rank=1 }
                {
                  emoji = (rank == 1 ? "ğŸ¥‡" : (rank == 2 ? "ğŸ¥ˆ" : (rank == 3 ? "ğŸ¥‰" : "â€¢")))
                  printf "%s %dìœ„: @%s (%d commits)\n", emoji, rank, $2, $1
                  rank++
                }'
            fi
            echo ""
            echo "_ìˆœìœ„ì— ì—†ìœ¼ì‹  ë¶„ë“¤ì€ ë‹¤ìŒ ì£¼ë¥¼ ë…¸ë ¤ë³´ì„¸ìš”! ğŸ”¥_"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send to Slack
        uses: slackapi/slack-github-action@v1.25.0
        with:
          # toJSONì„ ì‚¬ìš©í•˜ì—¬ íŠ¹ìˆ˜ë¬¸ì/ì¤„ë°”ê¿ˆìœ¼ë¡œ ì¸í•œ JSON ê¹¨ì§ ë°©ì§€
          payload: |
            {
              "text": ${{ toJSON(steps.ranking.outputs.content) }}
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
