name: ğŸ† Weekly Study Leaderboard

on:
  schedule:
    - cron: '0 0 * * 1' # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  leaderboard:
    runs-on: ubuntu-latest
    steps:
      - name: Get Last Week Date
        id: date
        run: echo "since=$(date -d '7 days ago' +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Calculate Ranking
        id: ranking
        run: |
          ORG_NAME="dangerous-office-workers"
          SINCE_DATE="${{ steps.date.outputs.since }}"

          echo "[INFO] $ORG_NAME ì˜ $SINCE_DATE ì´í›„ ê¸°ë¡ì„ ì°¾ìŠµë‹ˆë‹¤..."
          
          # 1. gh api í˜¸ì¶œ ë°©ì‹ ë³€ê²½
          QUERY="org:$ORG_NAME author-date:>=$SINCE_DATE merge:false"
          AUTHORS=$(gh api "search/commits" -f q="$QUERY" --jq '.items[].author.login' || echo "")

          # 2. GITHUB_OUTPUT ë©€í‹°ë¼ì¸ ì‘ì„±ë²• ìˆ˜ì •
          echo "content<<EOF" >> $GITHUB_OUTPUT
          
          if [ -z "$AUTHORS" ]; then
            echo "ì§€ë‚œì£¼ì—ëŠ” í™œë™í•œ ë©¤ë²„ê°€ ì—†ë„¤ìš”. ëª¨ë‘ ë” ìœ„í—˜í•´ì§€ë„ë¡ ë¶„ë°œí•˜ì„¸ìš”! â„ï¸" >> $GITHUB_OUTPUT
          else
            echo "ì§€ë‚œ ì¼ì£¼ì¼ê°„ì˜ ëª…ì˜ˆì˜ ì „ë‹¹ì…ë‹ˆë‹¤! ğŸ†" >> $GITHUB_OUTPUT
            # ë­í‚¹ ê³„ì‚° ë¡œì§
            echo "$AUTHORS" | sort | uniq -c | sort -rn | awk '
              BEGIN { rank=1 }
              {
                emoji = (rank == 1 ? "ğŸ¥‡" : (rank == 2 ? "ğŸ¥ˆ" : (rank == 3 ? "ğŸ¥‰" : "â€¢")))
                print emoji " " rank "ìœ„: @" $2 " (" $1 " commits)"
                rank++
              }
            ' >> $GITHUB_OUTPUT
          fi
          
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send to Slack
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "ğŸ“¢ *[ìœ„í—˜í•œ ì§ì¥ì¸ë“¤] ì´ë²ˆ ì£¼ ìŠ¤í„°ë”” ë­í‚¹ ì •ë¦¬*\n${{ steps.ranking.outputs.content }}\n\n_ìˆœìœ„ì— ì—†ìœ¼ì‹  ë¶„ë“¤ì€ ë‹¤ìŒ ì£¼ë¥¼ ë…¸ë ¤ë³´ì„¸ìš”! ğŸ”¥_"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
